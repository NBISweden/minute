from utils import read_libraries, MultiplexedReplicate


libraries = [
    lib
    for lib in read_libraries("libraries.tsv")
    if not isinstance(lib, MultiplexedReplicate)
]


rule download_all:
    input:
        expand("fastq/{accession}_R{rn}.fastq.gz", accession = [lib.fastqbase for lib in libraries], rn = [1, 2])


rule download_sra:
    output:
        r1="fastq/{accession}_R1.fastq.gz",
        r2="fastq/{accession}_R2.fastq.gz"
    threads:
        9999  # Prevent parallel downloads
    shell:
        """\
        mkdir -p tmp/download
        ( cd tmp/download && fastq-dump --gzip --split-3 --defline-qual '+' --defline-seq '@$sn' {wildcards.accession} )
        mv tmp/download/{wildcards.accession}_1.fastq.gz {output.r1}
        mv tmp/download/{wildcards.accession}_2.fastq.gz {output.r2}\
        """
